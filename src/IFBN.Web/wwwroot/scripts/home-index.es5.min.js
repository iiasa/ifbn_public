"use strict";(function(n){var t=function(n){var t;return t=n.network.trim().toLowerCase()=="afritron"?"red":n.network.trim().toLowerCase()=="rainfor"?"red":n.network.trim().toLowerCase()=="tforces"?"red":n.network.trim().toLowerCase()=="forestgeo"?"green":n.network.trim().toLowerCase()=="tmfo"?"blue":n.network.trim().toLowerCase()=="iiasa"?"peru":"black",new ol.style.Style({image:new ol.style.Circle({radius:4,fill:new ol.style.Fill({color:"#cccccc"}),stroke:new ol.style.Stroke({color:t,width:1})})})},i=function(n){var t;return t=n.network.trim().toLowerCase()=="afritron"?"red":n.network.trim().toLowerCase()=="rainfor"?"red":n.network.trim().toLowerCase()=="tforces"?"red":n.network.trim().toLowerCase()=="forestgeo"?"green":n.network.trim().toLowerCase()=="tmfo"?"blue":n.network.trim().toLowerCase()=="iiasa"?"peru":"black",new ol.style.Style({stroke:new ol.style.Stroke({color:t,lineDash:[4],width:3}),fill:new ol.style.Fill({color:"rgba(0, 0, 255, 0.1)"})})},r=function(n){var u={},f="black",i=n.get("features").length,r=u[i],t;return i>0&&(t=n.get("features")[0],f=t.network.trim().toLowerCase()=="afritron"?"red":t.network.trim().toLowerCase()=="rainfor"?"red":t.network.trim().toLowerCase()=="tforces"?"red":t.network.trim().toLowerCase()=="forestgeo"?"green":t.network.trim().toLowerCase()=="tmfo"?"blue":t.network.trim().toLowerCase()=="iiasa"?"peru":"black"),r||(r=new ol.style.Style({image:new ol.style.Circle({radius:10,stroke:new ol.style.Stroke({color:"#fff"}),fill:new ol.style.Fill({color:f})}),text:new ol.style.Text({text:i.toString(),fill:new ol.style.Fill({color:"#fff"})})}),u[i]=r),r};n.map=function(){var u={},f=new ol.Attribution({html:'Tiles &copy; <a href="https://earthenginepartners.appspot.com/science-2013-global-forest">Global Forest Change (Hansen et. al.)<\/a>'}),n;return u.viewModel={loading:ko.observable(!1),title:ko.observable(""),siteDetails:ko.observable(""),plotDetails:ko.observable(""),photoUrl:ko.observable(""),link:ko.observable("")},n=function(n){return n===null||n===undefined},u.initialize=function(e,o){for(var nt,tt,l,s,a,ut,v,g,ft,et,p=[],w=[],b=[],y=new ol.format.WKT,h=0;h<e.length;h++)e[h].geometryWKT!==null&&e[h].geometryWKT.trim()!==""&&(l=y.readFeature(e[h].geometryWKT,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),l.id=e[h].id,l.name=e[h].plotName,l.network=e[h].network,p.push(l));for(s=0;s<o.length;s++)o[s].geometryWKT!==null&&o[s].geometryWKT.trim()!==""&&(a=y.readFeature(o[s].geometryWKT,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),a.id=o[s].id,a.name=o[s].plotName,a.network=o[s].network,b.push(a));for(nt=new ol.layer.Vector({title:"Plot data available here",visible:!0,source:new ol.source.Vector({features:new ol.Collection(p)}),style:t}),tt=new ol.layer.Vector({title:"Potentially available, curated by partner networks",visible:!0,source:new ol.source.Vector({features:new ol.Collection(b)}),style:new ol.style.Style({image:new ol.style.Circle({radius:4,fill:new ol.style.Fill({color:"#cccccc"}),stroke:new ol.style.Stroke({color:"#FFFFFF",width:1})})})}),h=0;h<e.length;h++)e[h].geometry_CornerWKT!==null&&e[h].geometry_CornerWKT.trim()!==""&&(l=y.readFeature(e[h].geometry_CornerWKT,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),l.id=e[h].id,l.name=e[h].plotName,l.network=e[h].network,w.push(l));for(s=0;s<o.length;s++)o[s].geometry_CornerWKT!==null&&o[s].geometry_CornerWKT.trim()!==""&&(a=y.readFeature(o[s].geometry_CornerWKT,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),a.id=o[s].id,a.name=o[s].plotName,a.network=o[s].network,w.push(a));var ot=new ol.layer.Vector({title:"Display plots' shape (plots'corners)",visible:!0,source:new ol.source.Vector({features:new ol.Collection(w)}),style:i}),it=20,st=new ol.source.Vector({features:new ol.Collection(p)}),ht=new ol.source.Cluster({distance:it,source:st}),k=new ol.layer.Vector({source:ht,visible:!0,style:r}),ct=new ol.source.Vector({features:new ol.Collection(b)}),lt=new ol.source.Cluster({distance:it,source:ct}),rt={},d=new ol.layer.Vector({source:lt,visible:!0,style:function(n){var i=n.get("features").length,t=rt[i];return t||(t=new ol.style.Style({image:new ol.style.Circle({radius:10,stroke:new ol.style.Stroke({color:"#fff"}),fill:new ol.style.Fill({color:"#ffffff"})}),text:new ol.style.Text({text:i.toString(),fill:new ol.style.Fill({color:"#000000"})})}),rt[i]=t),t}}),c=new ol.Map({target:"map",layers:[new ol.layer.Group({title:"Base maps",layers:[new ol.layer.Tile({title:"Satellite",visible:!0,type:"base",preload:Infinity,source:new ol.source.BingMaps({key:"Ar15IjogfL-tAKydaSWky9VA4om_p2J9jq2H0U2Ubp5muXDVPIBcuMXoScPlar0X",imagerySet:"Aerial",maxZoom:19})}),new ol.layer.Tile({title:"Satellite with Labels",visible:!1,type:"base",preload:Infinity,source:new ol.source.BingMaps({key:"Ar15IjogfL-tAKydaSWky9VA4om_p2J9jq2H0U2Ubp5muXDVPIBcuMXoScPlar0X",imagerySet:"AerialWithLabels",maxZoom:19})}),new ol.layer.Tile({title:"Roadmap",visible:!1,type:"base",preload:Infinity,source:new ol.source.BingMaps({key:"Ar15IjogfL-tAKydaSWky9VA4om_p2J9jq2H0U2Ubp5muXDVPIBcuMXoScPlar0X",imagerySet:"Road",maxZoom:19})})]}),new ol.layer.Group({title:"Overlays",layers:[new ol.layer.Tile({title:"Hansen Tree Cover 2000",visible:!1,source:new ol.source.XYZ({attributions:[f],url:"https://storage.googleapis.com/earthenginepartners-hansen/tiles/gfc2015/tree_alpha/{z}/{x}/{y}.png"})}),new ol.layer.Tile({title:"airborne LiDAR-based biomass maps",visible:!1,source:new ol.source.TileWMS({url:"https://wms.geo-wiki.org/cgi-bin/biomasswms",params:{LAYERS:"AfriSAR_Lope_AGB_50m,AfriSAR_Mabounie_AGB_50m,AfriSAR_Mondah_AGB_50m,AfriSAR_Rabi_AGB_50m,TropiSAR_Arbocel_AGB_50m,TropiSAR_Nouragues_AGB_50m,TropiSAR_Paracou_AGB_50m",TILED:!0},serverType:"mapserver",attributions:[new ol.Attribution({html:'<a href="https://doi.org/10.1109/JSTARS.2018.2851606" target="_blank" style="font-size: 12px; display: block; text-align: left; font-weight: bolder">LiDAR map reference<\/a><br/>'})]})}),new ol.layer.Tile({title:"Tropics by WUR",visible:!1,source:new ol.source.TileWMS({url:"https://wms.geo-wiki.org/cgi-bin/biomasswms",params:{LAYERS:"Avitabile_AGB_Map",TILED:!0},serverType:"mapserver"})}),new ol.layer.Tile({title:"GlobBiomass",visible:!1,source:new ol.source.TileWMS({url:"https://wms.geo-wiki.org/cgi-bin/biomasswms",params:{LAYERS:"GlobBiomass",TILED:!0},serverType:"mapserver"})})]}),new ol.layer.Group({title:"Plots",layers:[tt,nt,ot]}),new ol.layer.Group({title:"clusters",layers:[k,d]})],view:new ol.View({center:ol.proj.transform([20,0],"EPSG:4326","EPSG:3857"),zoom:3})});c.getView().on("propertychange",function(n){switch(n.key){case"resolution":var t=parseInt(c.getView().getZoom());t>=15?(k.setVisible(!1),d.setVisible(!1)):t<15&&(k.setVisible(!0),d.setVisible(!0))}});ut=new ol.control.LayerSwitcher({tipLabel:"Legend"});c.addControl(ut);v=$("#info");v.tooltip({animation:!1,trigger:"manual"});g=function(t,i){var f,r,e,u;if(v.css({left:t[0]+15+"px",top:t[1]+"px"}),f=c.forEachFeatureAtPixel(t,function(n){return n}),f)r=f.name,n(r)&&(r=""),v.tooltip("hide").attr("data-original-title",r).tooltip("fixTitle").tooltip("show");else if(n(i))v.tooltip("hide");else{e="";for(u in i)i.hasOwnProperty(u)&&(e+=u+": "+Math.round(i[u])+"\n");v.tooltip("hide").attr("data-original-title",e).tooltip("fixTitle").tooltip("show")}};c.on("pointermove",function(n){if(n.dragging){v.tooltip("hide");return}g(c.getEventPixel(n.originalEvent))});ft=document.getElementById("popup");et=new ol.Overlay({element:ft,positioning:"bottom-center",stopEvent:!1});c.addOverlay(et);c.on("click",function(t){var i,r;if(u.viewModel.title(""),u.viewModel.siteDetails(""),u.viewModel.plotDetails(""),u.viewModel.photoUrl(""),u.viewModel.link(""),u.viewModel.loading(!1),i=c.forEachFeatureAtPixel(t.pixel,function(n){return n}),n(i)||n(i.id)){if(c.getView().getZoom()>12){var f=ol.proj.transform(t.coordinate,"EPSG:3857","EPSG:4326"),e=f[0],o=f[1];api.callJson("Landcover","getIFBNLidarValues",{latitude:o,longitude:e},function(n){$.isEmptyObject(n)||g(c.getEventPixel(t.originalEvent),n)})}}else r=i.id,u.viewModel.loading(!0),setTimeout(function(){$.getJSON("/plot/"+r,function(t){var r,e,f,o,s;if(n(t))u.viewModel.title(i.get("name")),u.viewModel.siteDetails(i.get("description"));else{if(u.viewModel.loading(!1),u.viewModel.title(t.siteName+" ("+t.plotName+")"),r="",n(t.country)||(r+="<p>"+t.country+"<\/p>"),n(t.network)||t.network.trim()===""||(r+="<p><b>Network:<\/b> "+t.network+"<\/p>"),n(t.institutions)||t.institutions.trim()===""||(r+="<p><b>Institutions:<\/b> "+t.institutions+"<\/p>"),t.network!==null&&t.url.trim()!==""&&(r+='<p><b>Link:<\/b> <a href="'+t.url+'" target="_blank">'+t.url+"<\/a><\/p>"),n(t.pIs_text)||t.pIs_text.trim()===""||(r+="<p><b>PIs:<\/b> "+t.pIs_text+"<\/p>"),n(t.area)||(r+="<p><b>Sub-plot area:<\/b> "+t.area,n(t.area_sum)||(r+="; <b>Plot area:<\/b> "+t.area_sum),r+="<\/p>"),n(t.altitude)&&n(t.slope)||(r+="<p>",n(t.altitude)||(r+="<b>Altitude:<\/b> "+t.altitude+"&nbsp;&nbsp;&nbsp;"),n(t.slope)||(r+="<b>Slope:<\/b> "+t.slope),r+="<\/p>"),n(t.biomassProcessingProtocol)||t.biomassProcessingProtocol.trim()===""||(r+='<p><b>Biomass Processing Protocol:<\/b> <a href="/Docs/biomass_processing_protocol/'+t.biomassProcessingProtocol+'" target="_blank">'+t.biomassProcessingProtocol+"<\/a><\/p>"),n(t.establishedDate)||(r+="<p><b>Established:<\/b> "+t.establishedDate+"<\/p>"),u.viewModel.siteDetails(r),e="",!n(t.censuses)&&t.censuses.length>0){if(f=t.censuses[0],n(f.censusDate)||(e+="<p><b>Census:<\/b> "+f.censusDate+"<\/p>"),!n(f.measurements)&&f.measurements.length>0){for(e+="<p><b>Measurements:<\/b> <br/>",o=0;o<f.measurements.length;o++)e+=f.measurements[o].measurement,f.measurements[o].additionalMeasurements!==null&&f.measurements[o].additionalMeasurements.length>0&&(e+=' <i class="fa fa-info-circle" aria-hidden="true" title="',e+=f.measurements[o].additionalMeasurements.join("\n"),e+='"><\/i>'),e+="<br/>";e+="<\/p>"}if(!n(f.taxonomicIdentifications)&&f.taxonomicIdentifications.length>0){for(e+="<p><b>Taxonomic Identifications:<\/b> <br/>",s=0;s<f.taxonomicIdentifications.length;s++)e+=f.taxonomicIdentifications[s]+"<br/>";e+="<\/p>"}}u.viewModel.plotDetails(e);t.photos.length>0&&u.viewModel.photoUrl("https://forest-observation-system.net/Images/sites/"+t.photos[0]);n(t.reference)||t.reference.trim()===""||u.viewModel.link("<p><b>Reference:<\/b> "+t.reference+"<\/p>")}})},800)});$("#downloadButton").on("click",function(){var t=$("#form_TermsConditions input:checked[type='checkbox']").val(),n,i,r;t!==null&&typeof t!="undefined"&&t.toString()==="true"?(n=$("#form_IntendedUse [type='text']").val(),n.trim()!=""?(i=$("#countrySelect").val(),r=$("#form_DownloadType input:checked[type='radio']").val(),window.location=r==="csv"?"/DownloadCSV/"+i+"/"+n:"/download/"+i+"/"+n):alert("Please enter intended use before downloading")):alert("Please accept terms and conditions before downloading")});$("#downloadButtonBBox").on("click",function(){var t=$("#form_TermsConditions input:checked[type='checkbox']").val(),n;if(t!==null&&typeof t!="undefined"&&t.toString()==="true")if(n=$("#form_IntendedUse [type='text']").val(),n.trim()!==""){var r=$("#form_DownloadType input:checked[type='radio']").val(),u=c.getView().calculateExtent(c.getSize()),i=ol.proj.transformExtent(u,"EPSG:3857","EPSG:4326");window.location=r==="csv"?"/DownloadBBoxCSV/"+i+"/"+n:"/DownloadBBox/"+i+"/"+n}else alert("Please enter intended use before downloading");else alert("Please accept terms and conditions before downloading")});ko.applyBindings(u.viewModel)},u}()})(window);